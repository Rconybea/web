<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-10-05 Thu 14:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>publishing static HTML</title>
<meta name="author" content="roly-desktop-23" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<div id="content" class="content">
<h1 class="title">publishing static HTML</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org53d83dd">1. Publish Static HTML</a>
<ul>
<li><a href="#orgc3bed80">1.1. base emacs configuration for publishing</a></li>
<li><a href="#org99f210d">1.2. setup for literate programming</a></li>
<li><a href="#orga19f438">1.3. HTML theme</a></li>
<li><a href="#org8e9b4d5">1.4. display HTML locally</a></li>
<li><a href="#orgf2a33cb">1.5. publish to github pages</a></li>
<li><a href="#org897c231">1.6. package as docker container</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org53d83dd" class="outline-2">
<h2 id="org53d83dd"><span class="section-number-2">1.</span> Publish Static HTML</h2>
<div class="outline-text-2" id="text-1">
<p>
In particular,  including this content.
Content formatted using <code>org-mode</code>.
</p>

<p>
Maintaining public <code>.org</code> content here: <a href="https://github.com/Rconybea/org-howto">https://github.com/Rconybea/org-howto</a>
</p>
</div>

<div id="outline-container-orgc3bed80" class="outline-3">
<h3 id="orgc3bed80"><span class="section-number-3">1.1.</span> base emacs configuration for publishing</h3>
<div class="outline-text-3" id="text-1-1">
<p>
See also
<a href="https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html">https://orgmode.org/worg/org-tutorials/org-publish-html-tutorial.html</a>
</p>

<p>
<code>org-publish-project-alist</code> configures org trees for publishing:
</p>
<div class="org-src-container">
<pre class="src src-elisp">;; ----------------------------------------------------------------
;; org-mode publishing
;;
(require 'ox-publish)

;; publishing setup -- this is a kitchen sink -- it's intended to cover
;; everything we want org-mode to publish
;;
(setq org-publish-project-alist
      '(
        ("org-howto"
         :components ("org-howto-notes" "org-howto-static"))

        ("org-howto-notes"
         :base-directory "~/proj/org-howto"
         :base-extension "org"
         :publishing-directory "~/proj/public_html/org-howto"
         :recursive t
         :publishing-function org-html-publish-to-html
         :headling-levels 4
         :auto-preamble t
         )

        ("org-howto-static"
         :base-directory "~/proj/org-howto"
         :base-extension "css\\|html\\|js\\|svg\\|png\\|jpg\\|gif\\|pdf\\|mp3\\|ogg\\|swf"
         :publishing-directory "~/proj/public_html/org-howto"
         :recursive t
         :publishing-function org-publish-attachment
         )
        )

        ; ... additional org trees here ...
        )
</pre>
</div>

<p>
With this configuration
</p>
<pre class="example" id="orgef16c27">
~M-x org-publish-project org-howto~
</pre>

<p>
generates HTML content in <code>~/proj/public_html/org-howto~</code>.
</p>
</div>
</div>

<div id="outline-container-org99f210d" class="outline-3">
<h3 id="org99f210d"><span class="section-number-3">1.2.</span> setup for literate programming</h3>
<div class="outline-text-3" id="text-1-2">
<p>
<code>org-mode</code> can automate weaving together content prepared by other programs,
for example <code>graphviz</code>.
</p>

<p>
<code>~/.emacs</code> Configuration for such adopted sources (as of 1oct2023 just graphviz):
</p>

<div class="org-src-container">
<pre class="src src-elisp">;; ----------------------------------------------------------------
;; org-mode babel setup
;; (execute dot/ditaa/bash/c++ etc. from .org code blocks)
;;
;; see
;;   [[https://orgmode.org/worg/org-contrib/babel/intro.html]]
;;   [[https://orgmode.org/worg/org-contrib/babel/languages/index.html]]
;;
;; code block:
;;   #+begin_src ${language} ${switches} ${headerarguments}
;;     ${body}
;;   #+end_src
;;
;; use header argument
;;   :results output
;; to insert code-block output (i.e. contents of stdout) into .org file below code block
;;
;; use
;;   :results value
;; to just take value of last statement
;;
;; use
;;   :session
;; to share language sub-process across code-blocks.
;;
;; can use
;;   #+name: foo
;; to name an org-mode table;  then:
;;   #+begin_src ... :var myfreevar=foo
;;     ...
;;   #+end_src
;; with body mentioning myfreevar;  .org will substitute foo
;;
;; can do inline coode block with
;;   src_&lt;${lang}&gt;{${code}} or src_&lt;${lang}[${args}]{${code}}
;; e.g.
;;   src_python[:session]{10*x}
;;
;; notes:
;;   [C-c C-v] org-babel prefix
;;   [C-c C-v b] -- evaluate code blocks in buffer
;;   [C-c C-v s] -- evaluate code blocks in subtree
;;   [C-c C-v e] -- evaluate code block at point
;;   [C-c '] M-x org-edit-src-code -- puts code block in new buffer with appropriate mode activated
;;   [C-c M-b p] M-x org-babel-expand-src-block -- show expanded code block prior to evaluation
;;   (org-babel-lob-ingest "path/to/file.org") to share code blogs as 'library'

(org-babel-do-load-languages
 'org-babel-load-languages
 '((dot . t)  ; graphviz [[https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-dot.html]] see also graphviz-dot-mode
   ))
</pre>
</div>

<p>
Example <code>.org</code> content using graphviz:
</p>

<pre class="example" id="org5e70581">
#+begin_src dot :file img/living-room-av/macmini.svg :exports results :cmdline -Tsvg
digraph {
  size="4,4";
  rankdir=LR;
  s [label="mac mini", shape="box"];
  r [label="receiver", shape="box"];
  m [label="monitor", shape="box"];
  sp [label="spkr", shape="ellipse"];
  s -&gt; r[label="VDP",color="red"];
  s -&gt; m[label="input#2",color="blue"];
  r -&gt; sp[color="red"];
}
#+end_src
</pre>

<p>
publishing (or using <code>C-c C-v b</code>) creates/updates file in <code>img/living-room-av/macmini.svg</code>
</p>
</div>
</div>

<div id="outline-container-orga19f438" class="outline-3">
<h3 id="orga19f438"><span class="section-number-3">1.3.</span> HTML theme</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Using Fabrice Niessen's awesome readtheorg theme see <a href="https://github.com/fniessen/org-html-themes">org-html-themes</a>
Cloned <code>.setup</code> file to <code>org-howto/ext/fniessen/theme-readtheorg.setup</code>.
Apply theme by including the following in each <code>.org</code> header:
</p>

<div class="org-src-container">
<pre class="src src-org"># options used exclusively by the html exporter
#+setupfile: ext/fniessen/theme-readtheorg.setup
</pre>
</div>
</div>
</div>

<div id="outline-container-org8e9b4d5" class="outline-3">
<h3 id="org8e9b4d5"><span class="section-number-3">1.4.</span> display HTML locally</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Once we have HTML in <code>~/proj/public_html/org-howto</code>,  can view it locally:
</p>
<div class="org-src-container">
<pre class="src src-sh">python3 -m http.server --directory ~/proj/public_html/org-howto 8080
</pre>
</div>

<p>
then point browser to <code>localhost:8080</code> (or for the content you're reading now: <code>localhost:8080/env/development-environment.html</code>)
</p>

<p>
Caveat: builtin python webserver doesn't support https.
</p>
</div>
</div>

<div id="outline-container-orgf2a33cb" class="outline-3">
<h3 id="orgf2a33cb"><span class="section-number-3">1.5.</span> publish to github pages</h3>
<div class="outline-text-3" id="text-1-5">
<p>
To work with github pages,  We tweak the <code>.org</code> tree slightly:
</p>
<div class="org-src-container">
<pre class="src src-sh">cd ~/proj/org-howto
ln -s ext web
</pre>
</div>

<p>
This is to match the github repo name <a href="https://github.com/Rconybea/web">https://github.com/Rconybea/web</a>.
When we publish <code>.org</code> tree to github pages, it appears at <a href="https://rconybea.github.io/web">https://rconybea.github.io/web</a>
</p>

<p>
<code>.org</code> pages that want to use root-relative paths, prefix with <code>/web</code>:
</p>
<pre class="example" id="org62ef73d">
#+infojs_opt: view:showall toc:nil ltoc:nil mouse:#ffc0c0 path:/web/ext/orginfo/org-info.js
#+html_head: &lt;link rel="stylesheet" type="text/css" href="/web/css/notebook.css" /&gt;
</pre>

<ol class="org-ol">
<li>github pages: <code>/web/ext/orginfo/org-info.js</code> resolves via <code>ext/orginfo/org-info.js</code>..</li>
<li>natively hosted: <code>/web/ext/orginfo/org-info.js</code> resolves via <code>web/ext/orginfo-org-info.js</code>.</li>
</ol>

<p>
Note that <code>org-publish</code> expands the <code>web</code> symlink,  so everything under the <code>ext</code> tree will be duplicated
</p>
</div>
</div>

<div id="outline-container-org897c231" class="outline-3">
<h3 id="org897c231"><span class="section-number-3">1.6.</span> package as docker container</h3>
<div class="outline-text-3" id="text-1-6">
<p>
We can snapshot and serve generated html in a dedicated docker container with this <code>flake.nix</code>
(in <code>~/proj/public_html</code>,  given html output written to <code>~/proj/public_html/org-howto</code>)
</p>

<div class="org-src-container">
<pre class="src src-yaml">{
  description = "publish org-howto-derived html";

  # dependencies of this flake
  inputs = rec {
    nixpkgs.url = "github:nixos/nixpkgs/23.05";
    org_howto_path = {
      url = "./org-howto";
      flake = false;
    };
  };

  outputs = { self, nixpkgs, org_howto_path } :
    let
      system = "x86_64-linux";
      pkgs = import nixpkgs { inherit system; };

      # creates shell script 'serve-org-howto'.
      # to use:
      #   $ cd ~/proj/public_html
      # A.
      #   $ nix build
      #   $ ./result/bin/serve-org-howto
      # B.
      #   $ nix run
      #
      serve_org_howto_deriv = pkgs.writeShellScriptBin "serve-org-howto" ''
        ${pkgs.python3}/bin/python3 -m http.server 8080 --directory ${org_howto_path}
      '';

      # builds custom docker image!
      serve_org_howto_docker_deriv =
        let
          serve_org_howto = self.packages.${system}.serve_org_howto;
        in
          pkgs.dockerTools.buildLayeredImage {
            name = serve_org_howto.name;
            tag = "1.0";
            contents = [ serve_org_howto ];

            config = {
              Cmd = [ "/bin/serve-org-howto" ];
              WorkingDir = "/";
            };
          };

    in rec {
      packages.${system} = {
        default = serve_org_howto_deriv;

        serve_org_howto = serve_org_howto_deriv;
        serve_org_howto_docker = serve_org_howto_docker_deriv;
      };
    };
}
</pre>
</div>

<ol class="org-ol">
<li><p>
build docker container image using <code>~/proj/public_html/flake.nix</code>:
</p>
<pre class="example" id="orgd519be0">
$ cd ~/proj/public_html
$ nix build
$ ls -ld result
/nix/store/dck2rix8n8sx6wi0d4is0fq17c72ddqx-serve-org-howto.tar.gz
</pre></li>

<li><p>
load image into docker
</p>
<pre class="example" id="org905762f">
$ docker load &lt;./result
</pre>

<p>
or send to some other host:
</p>
<pre class="example" id="orgcebc326">
$ mycloudhost=...
$ scp /nix/store/dck2rix8n8sx6wi0d4is0fq17c72ddqx-serve-org-howto.tar.gz root@${mycloudhost}
$ ssh ${mycloudhost}

mycloudhost$ docker load &lt; /nix/store/dck2rix8n8sx6wi0d4is0fq17c72ddqx-serve-org-howto.tar.gz
mycloudhost$ docker images
REPOSITORY        TAG       IMAGE ID       CREATED        SIZE
serve-org-howto   1.0       113e8c1232fa   53 years ago   165MB
mycloudhost$ docker run serve-org-howto
</pre>

<p>
HTML tree now served from <code>${mycloudhost}:8080</code>
</p>

<p>
Docker image contains only python and our html tree,  so much smaller than typical image.
</p></li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: roly-desktop-23</p>
<p class="date">Created: 2023-10-05 Thu 14:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>